<!DOCTYPE html>
<html lang="en-US" class="size-full">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=width=device-width, initial-scale=1.0"
    />

    <script src="https://cdn.jsdelivr.net/npm/@unocss/runtime"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@unocss/reset/tailwind.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
      integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <link type="text/css" rel="stylesheet" href="/css/site.css" />

    <title>Login - muLab</title>
    <meta name="title" content="Login - muLab" />
    <meta
      name="description"
      content="Mahindra University's online code editor and compiler"
    />
    <meta name="author" content="Atharv Garg" />

    <link rel="shortcut icon" href="/favicons/favicon.ico" />
    <link rel="icon" type="image/svg+xml" href="/favicons/favicon.svg" />
    <link
      rel="icon"
      type="image/png"
      sizes="96x96"
      href="/favicons/favicon-96x96.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/favicons/favicon-180x180.png"
    />
    <meta name="apple-mobile-web-app-title" content="muLab" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="theme-color" content="#ffffff" />

    <style>
      .login-container {
        max-width: 400px;
        width: 100%;
        padding: 2rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .dark .login-container {
        background-color: rgba(24, 24, 27, 0.8);
        border: 1px solid rgba(63, 63, 70, 0.5);
      }

      .login-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        margin-bottom: 1rem;
        border: 1px solid rgba(229, 231, 235, 1);
        border-radius: 0.375rem;
        background-color: transparent;
      }

      .dark .login-input {
        border-color: rgba(63, 63, 70, 1);
        color: white;
      }

      .login-input:focus {
        outline: none;
        border-color: rgba(59, 130, 246, 0.5);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
      }

      .login-btn {
        width: 100%;
        padding: 0.5rem 0.75rem;
        background-color: #1e40af; /* blue-800 */
        color: white;
        border: none;
        border-radius: 0.375rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .login-btn:hover {
        background-color: #1e3a8a; /* blue-900 */
      }

      .dark .login-btn:hover {
        background-color: #3b82f6; /* blue-500 */
      }

      .error-message {
        color: #ef4444; /* red-500 */
        margin-bottom: 1rem;
        font-size: 0.875rem;
        display: none;
      }

      .loading-spinner {
        display: none;
        margin-left: 0.5rem;
      }
    </style>
  </head>

  <body
    class="flex flex-col text-black bg-white size-full dark:bg-black dark:text-white"
  >
    <header class="flex items-center p-1 space-x-1">
      <a
        href="https://judge0.com"
        target="_blank"
        rel="noopener"
        tabindex="-1"
        class="w-8 h-8 rounded-md"
      >
        <img src="./images/icon_var2_rounded_512.png" />
      </a>
      <h1 class="text-xl font-semibold">muLab</h1>
      <button
        id="theme-toggle-btn"
        class="inline-flex items-center justify-center w-8 h-8 gap-2 text-sm transition rounded-md text-zinc-800 dark:text-white dark:hover:bg-zinc-700 dark:bg-zinc-800 focus-visible:outline-none focus-visible:ring-2 bg-zinc-100 hover:bg-zinc-200 whitespace-nowrap ml-auto"
      >
        <i class="fa-solid fa-sun"></i>
      </button>
    </header>

    <main class="flex-grow flex items-center justify-center p-4">
      <div class="login-container bg-white dark:bg-zinc-900">
        <div class="text-center mb-6">
          <h2 class="text-2xl font-bold">Login to muLab</h2>
          <p class="text-zinc-600 dark:text-zinc-400 text-sm mt-2">
            Enter your Moodle credentials to access the code editor
          </p>
        </div>

        <div id="error-message" class="error-message">
          Invalid username or password. Please try again.
        </div>

        <form id="loginForm">
          <div class="mb-4">
            <label for="username" class="block text-sm font-medium mb-1"
              >Username</label
            >
            <input
              type="text"
              id="username"
              name="username"
              class="login-input"
              placeholder="Enter your username"
              required
            />
          </div>
          <div class="mb-6">
            <label for="password" class="block text-sm font-medium mb-1"
              >Password</label
            >
            <div class="relative">
              <input
                type="password"
                id="password"
                name="password"
                class="login-input pr-10"
                placeholder="Enter your password"
                required
              />
              <button
                type="button"
                id="toggle-password"
                class="absolute inset-y-5 right-0 pr-3 flex items-center"
                aria-label="Toggle password visibility"
              >
                <i class="fa-solid fa-eye"></i>
              </button>
            </div>
          </div>
          <button type="submit" class="login-btn">
            Log In
            <span class="loading-spinner">
              <i class="fa-solid fa-circle-notch fa-spin"></i>
            </span>
          </button>
        </form>
      </div>
    </main>

    <footer
      class="text-xs text-center transition opacity-40 hover:opacity-100 p-2"
    >
      <a href="https://judge0.com" target="_blank" rel="noopener" tabindex="-1">
        Â© <span id="year">2025</span> AviatorGator - All Rights Reserved.
      </a>
    </footer>

    <script>
      // Set current year
      document.getElementById("year").textContent = new Date().getFullYear();

      // Theme toggling
      const themeToggleBtn = document.getElementById("theme-toggle-btn");
      const prefersDarkScheme = window.matchMedia(
        "(prefers-color-scheme: dark)"
      );

      // Check for saved theme preference or use the system preference
      const savedTheme = localStorage.getItem("theme");

      if (savedTheme === "dark" || (!savedTheme && prefersDarkScheme.matches)) {
        document.documentElement.classList.add("dark");
        themeToggleBtn.innerHTML = '<i class="fa-solid fa-moon"></i>';
      } else {
        document.documentElement.classList.remove("dark");
        themeToggleBtn.innerHTML = '<i class="fa-solid fa-sun"></i>';
      }

      // Toggle theme when button is clicked
      themeToggleBtn.addEventListener("click", () => {
        const isDark = document.documentElement.classList.toggle("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        themeToggleBtn.innerHTML = isDark
          ? '<i class="fa-solid fa-moon"></i>'
          : '<i class="fa-solid fa-sun"></i>';
      });

      // Check if user is already logged in
      if (sessionStorage.getItem("loggedIn") === "true") {
        window.location.href = "/index.html";
      }

      // Login form submission
      document
        .getElementById("loginForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const username = document.getElementById("username").value;
          const password = document.getElementById("password").value;
          const errorMessage = document.getElementById("error-message");
          const loadingSpinner = document.querySelector(".loading-spinner");

          // Hide error message and show loading spinner
          errorMessage.style.display = "none";
          loadingSpinner.style.display = "inline-block";

          // Disable button during request
          const loginButton = document.querySelector(".login-btn");
          loginButton.disabled = true;

          fetch("https://ide-login.euclid-mu.in/api/moodle-login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username: username, password: password }),
          })
            .then((response) => {
              if (!response.ok) {
                return response
                  .json()
                  .then((data) => {
                    throw new Error(data.message || "Login failed");
                  })
                  .catch(() => {
                    throw new Error("Login failed");
                  });
              }
              return response.json();
            })
            .then((data) => {
              if (data.success) {
                // Store auth info in session storage
                sessionStorage.setItem("loggedIn", "true");
                sessionStorage.setItem("userId", data.userId);
                sessionStorage.setItem("username", data.username);
                sessionStorage.setItem("fullName", data.fullName || username);

                // Store admin status if present
                if (data.isAdmin) {
                  sessionStorage.setItem("isAdmin", "true");
                }

                // Redirect to main page
                window.location.href = "/index.html";
              } else {
                throw new Error(data.message || "Login failed");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              errorMessage.textContent =
                error.message ||
                "Authentication failed. Please check your credentials.";
              errorMessage.style.display = "block";
              loadingSpinner.style.display = "none";
              loginButton.disabled = false;
            });
        });

      // Fix opacity issue
      setTimeout(function () {
        document.body.style.opacity = 1;
      }, 0);

      // Toggle password visibility
      const togglePasswordButton = document.getElementById("toggle-password");
      const passwordInput = document.getElementById("password");

      if (togglePasswordButton) {
        togglePasswordButton.addEventListener("click", () => {
          const isPassword = passwordInput.type === "password";
          passwordInput.type = isPassword ? "text" : "password";
          togglePasswordButton.innerHTML = isPassword
            ? '<i class="fa-solid fa-eye-slash"></i>'
            : '<i class="fa-solid fa-eye"></i>';
        });
      }
    </script>
  </body>
</html>
